<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather API - Application M√©t√©o</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        * {
            font-family: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            letter-spacing: -0.01em;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', 'Inter', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .display-4, .display-1, .display-2, .display-3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            letter-spacing: -0.03em;
        }
        
        #forecast-container h1, #forecast-container h2, #forecast-container h3, #forecast-container h4, #forecast-container h5 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        #forecast-container .fw-bold {
            font-weight: 600;
        }
        
        .card-header h5, .card-header h4 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            letter-spacing: -0.01em;
        }
        
        /* Styles sp√©cifiques pour les pr√©visions */
        #current-day, #current-date {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }
        
        #current-temp {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            letter-spacing: -0.05em;
        }
        
        #today-high, #today-low, #tomorrow-high, #tomorrow-low,
        #morning-temp, #afternoon-temp, #evening-temp {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            letter-spacing: -0.03em;
        }
        
        .badge, .btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            letter-spacing: 0.01em;
        }
        
        /* Am√©lioration de la lisibilit√© */
        .text-white, .text-white-50 {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        #hourly-forecast > div, #7day-forecast > div {
            font-family: 'Inter', sans-serif;
        }
        
        #hourly-forecast .fw-bold, #7day-forecast .fw-bold {
            font-weight: 600;
        }
        
        /* Styles pour les boutons d'humeur */
        .mood-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border: 3px solid transparent !important;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mood-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .mood-btn.btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .mood-btn.btn-warning {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
        }
        
        .mood-btn.btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .mood-btn.btn-outline-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #6c757d;
        }
        
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: none;
        }
        
        .bg-primary, .bg-success, .bg-warning, .bg-danger, .bg-dark, .bg-secondary, .bg-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9)) !important;
        }
        
        .bg-success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.9), rgba(25, 135, 84, 0.9)) !important;
        }
        
        .bg-warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 152, 0, 0.9)) !important;
        }
        
        .bg-danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.9), rgba(200, 35, 51, 0.9)) !important;
        }
        
        .bg-dark {
            background: linear-gradient(135deg, rgba(33, 37, 41, 0.9), rgba(52, 58, 64, 0.9)) !important;
        }
        
        .bg-secondary {
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.9), rgba(73, 80, 87, 0.9)) !important;
        }
        
        .bg-info {
            background: linear-gradient(135deg, rgba(13, 202, 240, 0.9), rgba(0, 180, 216, 0.9)) !important;
        }
        
        #hourly-forecast, #7day-forecast {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }
        
        #hourly-forecast::-webkit-scrollbar, #7day-forecast::-webkit-scrollbar {
            height: 8px;
        }
        
        #hourly-forecast::-webkit-scrollbar-track, #7day-forecast::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        #hourly-forecast::-webkit-scrollbar-thumb, #7day-forecast::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        
        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        #forecast-container .card {
            transition: transform 0.3s ease;
        }
        
        #forecast-container .card:hover {
            transform: translateY(-5px);
        }
        
        #hourly-forecast > div, #7day-forecast > div {
            transition: transform 0.2s ease;
        }
        
        #hourly-forecast > div:hover, #7day-forecast > div:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>

  <div class="container">
    <h1>Votre m√©t√©o</h1>
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" id="tab-current" href="#" onclick="showTab('current'); return false;">
                Actuel
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="tab-forecast" href="#" onclick="showTab('forecast'); return false;">
                Pr√©visions
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="./all.html">
                Historique
            </a>
        </li>
    </ul>
</div>

<div class="container py-5">
    <!-- Onglet Actuel -->
    <div id="tab-content-current">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-10 col-md-8">
                <!-- Section Coordonn√©es -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìç Votre position</h5>
                    </div>
                    <div class="card-body">
                        <div id="geolocation-prompt" class="alert alert-info text-center">
                            <p class="mb-3">
                                <strong>üîí Autorisation requise</strong><br>
                                Cette application a besoin d'acc√©der √† votre position pour afficher les donn√©es m√©t√©o de votre localisation.
                            </p>
                            <button id="request-geolocation" class="btn btn-primary btn-lg">
                                üìç Autoriser la g√©olocalisation
                            </button>
                        </div>
                        <div id="coordinates-display" style="display: none;">
                            <p class="text-center mb-2">
                                <strong>Latitude :</strong> <span id="latitude" class="badge bg-info">‚Äî</span> &deg;
                            </p>
                            <p class="text-center mb-2">
                                <strong>Longitude :</strong> <span id="longitude" class="badge bg-info">‚Äî</span> &deg;
                            </p>
                            <div class="text-center mt-3">
                                <button id="refresh-location" class="btn btn-outline-primary btn-sm">
                                    üîÑ Actualiser la position
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Donn√©es m√©t√©o -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üå§Ô∏è Donn√©es m√©t√©orologiques</h5>
                    </div>
                    <div class="card-body text-center">
                        <p class="mb-2">
                            <strong>Pays :</strong> <span id="country">‚Äî</span>
                        </p>
                        <p class="mb-3">
                            <strong>Ville :</strong> <span id="city">‚Äî</span>
                        </p>
                        <div class="mb-3">
                            <img id="icon" alt="Weather Icon" style="display: none; width: 64px; height: 64px;">
                        </div>
                        <p class="mb-2">
                            <strong>Condition :</strong> <span id="summary">‚Äî</span>
                        </p>
                        <p class="mb-3">
                            <strong>Temp√©rature :</strong> <span id="temperature" class="fs-4 fw-bold">‚Äî</span> &deg;C
                        </p>
                        <hr>
                        <p class="mb-2">
                            <strong>Niveau de pollution de l'air (index UK DEFRA) :</strong> 
                            <span id="airQualityIndex" class="badge bg-warning text-dark">‚Äî</span>
                        </p>
                        <p class="mb-0">
                            <strong>Concentration de particules fines (PM2,5) :</strong> 
                            <span id="pm25" class="badge bg-secondary">‚Äî</span> (¬µg/m¬≥)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglet Pr√©visions -->
    <div id="tab-content-forecast" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-12">
                <!-- Vue moderne des pr√©visions -->
                <div id="forecast-container" style="display: none;">
                    <!-- Jour actuel et m√©triques d√©taill√©es -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card bg-primary text-white" style="border-radius: 15px;">
                                <div class="card-body p-4">
                                    <h2 id="current-day" class="text-white mb-2">‚Äî</h2>
                                    <p id="current-date" class="text-white-50 mb-3">‚Äî</p>
                                    <h1 id="current-temp" class="display-4 text-white mb-2">‚Äî¬∞C</h1>
                                    <p id="current-condition" class="text-white mb-3">‚Äî</p>
                                    <img id="current-icon-large" alt="Weather Icon" style="width: 80px; height: 80px; display: none;">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8 mb-3">
                            <div class="card bg-primary text-white" style="border-radius: 15px;">
                                <div class="card-body p-4">
                                    <div class="row">
                                        <div class="col-6 mb-3">
                                            <small class="text-white-50">UV Index</small>
                                            <p class="mb-0"><strong id="uv-index">‚Äî</strong></p>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-white-50">Vent</small>
                                            <p class="mb-0"><strong id="wind">‚Äî</strong></p>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-white-50">Humidit√©</small>
                                            <p class="mb-0"><strong id="humidity">‚Äî</strong></p>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-white-50">Point de ros√©e</small>
                                            <p class="mb-0"><strong id="dew-point">‚Äî</strong></p>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-white-50">Pression</small>
                                            <p class="mb-0"><strong id="pressure">‚Äî</strong></p>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <small class="text-white-50">Visibilit√©</small>
                                            <p class="mb-0"><strong id="visibility">‚Äî</strong></p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-white-50">üåÖ Lever du soleil</small>
                                            <p class="mb-0"><strong id="sunrise">‚Äî</strong></p>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-white-50">üåá Coucher du soleil</small>
                                            <p class="mb-0"><strong id="sunset">‚Äî</strong></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pr√©visions horaires -->
                    <div class="card mb-4" style="border-radius: 15px;">
                        <div class="card-header bg-info text-white" style="border-radius: 15px 15px 0 0;">
                            <h5 class="mb-0">Pr√©visions horaires</h5>
                        </div>
                        <div class="card-body">
                            <div id="hourly-forecast" class="d-flex overflow-auto pb-2" style="gap: 15px;">
                                <!-- Les pr√©visions horaires seront ajout√©es ici -->
                            </div>
                        </div>
                    </div>

                    <!-- Aujourd'hui et Demain -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card bg-success text-white" style="border-radius: 15px;">
                                <div class="card-body p-4">
                                    <h4 class="mb-3">AUJOURD'HUI</h4>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <h2 id="today-high" class="mb-1">‚Äî¬∞C</h2>
                                            <p id="today-condition" class="mb-0 small">‚Äî</p>
                                        </div>
                                        <img id="today-icon" alt="Today Icon" style="width: 60px; height: 60px; display: none;">
                                    </div>
                                    <hr class="bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h2 id="today-low" class="mb-1">‚Äî¬∞C</h2>
                                            <p id="today-night-condition" class="mb-0 small">‚Äî</p>
                                        </div>
                                        <img id="today-night-icon" alt="Tonight Icon" style="width: 50px; height: 50px; display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card bg-warning text-dark" style="border-radius: 15px;">
                                <div class="card-body p-4">
                                    <h4 class="mb-3">DEMAIN</h4>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <h2 id="tomorrow-high" class="mb-1">‚Äî¬∞C</h2>
                                            <p id="tomorrow-condition" class="mb-0 small">‚Äî</p>
                                        </div>
                                        <img id="tomorrow-icon" alt="Tomorrow Icon" style="width: 60px; height: 60px; display: none;">
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h2 id="tomorrow-low" class="mb-1">‚Äî¬∞C</h2>
                                            <p id="tomorrow-night-condition" class="mb-0 small">‚Äî</p>
                                        </div>
                                        <img id="tomorrow-night-icon" alt="Tomorrow Night Icon" style="width: 50px; height: 50px; display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pr√©visions par partie de journ√©e -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card bg-secondary text-white" style="border-radius: 15px;">
                                <div class="card-body p-4 text-center">
                                    <h5 class="mb-3">MATIN</h5>
                                    <h3 id="morning-temp" class="mb-2">‚Äî¬∞C</h3>
                                    <p id="morning-condition" class="mb-2">‚Äî</p>
                                    <img id="morning-icon" alt="Morning Icon" style="width: 50px; height: 50px; display: none; margin: 0 auto;">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-danger text-white" style="border-radius: 15px;">
                                <div class="card-body p-4 text-center">
                                    <h5 class="mb-3">APR√àS-MIDI</h5>
                                    <h3 id="afternoon-temp" class="mb-2">‚Äî¬∞C</h3>
                                    <p id="afternoon-condition" class="mb-2">‚Äî</p>
                                    <img id="afternoon-icon" alt="Afternoon Icon" style="width: 50px; height: 50px; display: none; margin: 0 auto;">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-dark text-white" style="border-radius: 15px;">
                                <div class="card-body p-4 text-center">
                                    <h5 class="mb-3">SOIR</h5>
                                    <h3 id="evening-temp" class="mb-2">‚Äî¬∞C</h3>
                                    <p id="evening-condition" class="mb-2">‚Äî</p>
                                    <img id="evening-icon" alt="Evening Icon" style="width: 50px; height: 50px; display: none; margin: 0 auto;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pr√©visions sur 7 jours -->
                    <div class="card" style="border-radius: 15px;">
                        <div class="card-header bg-primary text-white" style="border-radius: 15px 15px 0 0;">
                            <h5 class="mb-0">Pr√©visions sur 7 jours</h5>
                        </div>
                        <div class="card-body">
                            <div id="7day-forecast" class="d-flex overflow-auto pb-2" style="gap: 20px;">
                                <!-- Les pr√©visions sur 7 jours seront ajout√©es ici -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message si pas de donn√©es -->
                <div id="forecast-no-data" class="alert alert-info text-center">
                    <p class="mb-3">Veuillez d'abord autoriser la g√©olocalisation et charger les donn√©es m√©t√©o dans l'onglet "Actuel".</p>
                    <button onclick="showTab('current'); return false;" class="btn btn-primary">Aller √† l'onglet Actuel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8">

            <!-- Section Configuration API -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">‚öôÔ∏è Configuration API</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <strong>‚ÑπÔ∏è Note :</strong> Cette application fonctionne enti√®rement c√¥t√© client. 
                        Les donn√©es sont stock√©es dans votre navigateur (localStorage).
                    </div>
            <div class="mb-3">
                        <label for="api-key" class="form-label"><strong>Cl√© API WeatherAPI :</strong></label>
                        <input type="text" id="api-key" class="form-control" placeholder="Entrez votre cl√© API WeatherAPI">
                        <small class="form-text text-muted">
                            Obtenez une cl√© gratuite sur <a href="https://www.weatherapi.com/signup.aspx" target="_blank">weatherapi.com</a>
                        </small>
                    </div>
                    <div class="d-grid">
                        <button id="save-api-key" class="btn btn-warning">
                            üíæ Enregistrer la cl√© API
                        </button>
                    </div>
                    <div id="api-key-status" class="mt-3" style="display: none;"></div>
                </div>
            </div>

            <!-- Section Enregistrement -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">üíæ Enregistrer votre localisation</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Humeur :</strong></label>
                        <div class="d-flex gap-3 flex-wrap mb-3" id="mood-selection">
                            <button type="button" class="btn btn-lg mood-btn" data-mood="happy" data-emoji="üòä" style="flex: 1; min-width: 120px; border-radius: 15px; padding: 1rem; font-size: 2rem; border: 3px solid transparent; transition: all 0.3s;">
                                üòä<br><small style="font-size: 0.8rem;">Heureux</small>
                            </button>
                            <button type="button" class="btn btn-lg mood-btn" data-mood="neutral" data-emoji="üòê" style="flex: 1; min-width: 120px; border-radius: 15px; padding: 1rem; font-size: 2rem; border: 3px solid transparent; transition: all 0.3s;">
                                üòê<br><small style="font-size: 0.8rem;">Neutre</small>
                            </button>
                            <button type="button" class="btn btn-lg mood-btn" data-mood="sad" data-emoji="üòî" style="flex: 1; min-width: 120px; border-radius: 15px; padding: 1rem; font-size: 2rem; border: 3px solid transparent; transition: all 0.3s;">
                                üòî<br><small style="font-size: 0.8rem;">Triste</small>
                            </button>
                        </div>
                        <input type="hidden" id="mood" value="">
                        <input type="hidden" id="mood-emoji" value="">
                        <small class="form-text text-muted">S√©lectionnez votre humeur actuelle</small>
                    </div>
            <div class="d-grid">
                        <button id="submit" class="btn btn-primary btn-lg">
                            üì§ Envoyer les donn√©es
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
let lat;
let long;
let city;
let country;
let condition;
let temperature;
let defra;
let pm25;

// Fonction pour afficher un message d'erreur
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger mt-3';
    errorDiv.textContent = message;
    const container = document.querySelector('.col-12.col-sm-10.col-md-8');
    if (container) {
        container.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    } else {
        console.error('Erreur:', message);
    }
}

// Fonction pour obtenir la cl√© API depuis localStorage
function getApiKey() {
    return localStorage.getItem('weatherApiKey') || '';
}

// Fonction pour sauvegarder la cl√© API
function saveApiKey(key) {
    localStorage.setItem('weatherApiKey', key);
}

// Fonction pour charger les donn√©es m√©t√©o
async function loadWeatherData(latitude, longitude) {
    try {
        console.log('üå§Ô∏è Chargement des donn√©es m√©t√©o pour:', latitude, longitude);
        
        const apiKey = getApiKey();
        
        if (!apiKey) {
            throw new Error('Veuillez d\'abord configurer votre cl√© API WeatherAPI');
        }
        
        // Appel direct √† l'API WeatherAPI depuis le navigateur
        const apiUrl = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${latitude},${longitude}&days=7&aqi=yes&alerts=yes`;
        console.log('üì° Appel API WeatherAPI direct:', apiUrl.replace(apiKey, 'API_KEY_HIDDEN'));
        
        let response;
        try {
            response = await fetch(apiUrl, {
                method: 'GET',
                mode: 'cors', // Explicitement activer CORS
        headers: {
                    'Accept': 'application/json'
                }
            });
        } catch (fetchError) {
            console.error('‚ùå Erreur de fetch:', fetchError);
            if (fetchError.message.includes('CORS') || fetchError.message.includes('Failed to fetch')) {
                throw new Error('Erreur CORS: L\'API WeatherAPI n√©cessite que la page soit servie via HTTP/HTTPS. Ouvrez le fichier via un serveur web local ou d√©ployez-le.');
            }
            throw fetchError;
        }
        
        // Lire le body une seule fois
        let json;
        const contentType = response.headers.get('content-type');
        
        if (!response.ok) {
            let errorMessage = `Erreur HTTP: ${response.status}`;
            try {
                if (contentType && contentType.includes('application/json')) {
                    json = await response.json();
                    console.error('‚ùå Erreur HTTP:', response.status, json);
                    errorMessage = json.message || json.error?.message || errorMessage;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur HTTP (texte):', response.status, errorText);
                    errorMessage = errorText || errorMessage;
                }
            } catch (e) {
                console.error('‚ùå Erreur lors de la lecture de la r√©ponse:', e);
            }
            throw new Error(errorMessage);
        }
        
        // Lire la r√©ponse JSON
        try {
            if (contentType && contentType.includes('application/json')) {
                json = await response.json();
            } else {
                const text = await response.text();
                console.error('‚ùå R√©ponse non-JSON re√ßue:', text);
                throw new Error('R√©ponse invalide du serveur (non-JSON)');
            }
        } catch (e) {
            console.error('‚ùå Erreur lors du parsing JSON:', e);
            throw new Error('R√©ponse invalide du serveur: ' + e.message);
        }
        console.log('‚úÖ Donn√©es re√ßues:', json);
        console.log('üìã Structure des donn√©es:', {
            hasLocation: !!json.location,
            hasCurrent: !!json.current,
            locationKeys: json.location ? Object.keys(json.location) : [],
            currentKeys: json.current ? Object.keys(json.current) : []
        });
        
        // V√©rifier si l'API a retourn√© une erreur
        if (json.error) {
            console.error('‚ùå Erreur API:', json.error);
            throw new Error(json.error.message || 'Erreur API m√©t√©o');
        }
        
        // V√©rifier que les donn√©es n√©cessaires existent
        if (!json.location) {
            console.error('‚ùå Pas de donn√©es location:', json);
            throw new Error('Donn√©es de localisation manquantes');
        }
        
        if (!json.current) {
            console.error('‚ùå Pas de donn√©es current:', json);
            throw new Error('Donn√©es m√©t√©o actuelles manquantes');
        }
        
        // R√©cup√©rer les donn√©es de localisation
        city = json.location.name || '‚Äî';
        country = json.location.country || '‚Äî';
        console.log('üìç Localisation extraite - Ville:', city, 'Pays:', country);
        
        // V√©rifier que les valeurs ne sont pas vides
        if (city === '‚Äî' || !city) {
            console.warn('‚ö†Ô∏è Ville vide, v√©rification des donn√©es:', json.location);
        }
        if (country === '‚Äî' || !country) {
            console.warn('‚ö†Ô∏è Pays vide, v√©rification des donn√©es:', json.location);
        }
        
        // R√©cup√©rer les donn√©es m√©t√©o
        condition = json.current.condition ? json.current.condition.text : '‚Äî';
        temperature = json.current.temp_c !== undefined ? json.current.temp_c : '‚Äî';
        console.log('üå°Ô∏è M√©t√©o extraite - Condition:', condition, 'Temp√©rature:', temperature + '¬∞C');
        
        // V√©rifier que les valeurs ne sont pas vides
        if (condition === '‚Äî' || !condition) {
            console.warn('‚ö†Ô∏è Condition vide, v√©rification des donn√©es:', json.current.condition);
        }
        if (temperature === '‚Äî' || temperature === undefined) {
            console.warn('‚ö†Ô∏è Temp√©rature vide, v√©rification des donn√©es:', json.current);
        }
        
        // R√©cup√©rer l'ic√¥ne m√©t√©o
        const iconElement = document.getElementById('icon');
        if (json.current.condition && json.current.condition.icon) {
            // Ajouter https: si l'URL commence par //
            let iconUrl = json.current.condition.icon;
            if (iconUrl.startsWith('//')) {
                iconUrl = 'https:' + iconUrl;
            }
            iconElement.src = iconUrl;
            iconElement.style.display = 'block';
            iconElement.style.margin = '0 auto';
            console.log('üñºÔ∏è Ic√¥ne:', iconUrl);
        } else {
            iconElement.style.display = 'none';
            console.log('‚ö†Ô∏è Pas d\'ic√¥ne disponible');
        }
        
        // R√©cup√©rer les donn√©es de qualit√© de l'air
        if (json.current.air_quality) {
            console.log('üí® Donn√©es qualit√© de l\'air:', json.current.air_quality);

            const defraIndex = json.current.air_quality['gb-defra-index'];
            let defraText = '‚Äî';

            if (defraIndex !== undefined && defraIndex !== null) {
            if (defraIndex === 1) {
            defraText = 'Faible';
            } else if (defraIndex === 2) {
            defraText = 'Mod√©r√©e';
            } else if (defraIndex === 3) {
            defraText = '√âlev√©e';
            } else if (defraIndex === 4) {
            defraText = 'Tr√®s √©lev√©e';
            } else {
            defraText = 'Ind√©termin√©';
}
            }
            
            defra = defraText;
            pm25 = json.current.air_quality.pm2_5 !== undefined && json.current.air_quality.pm2_5 !== null 
                ? json.current.air_quality.pm2_5 
                : '‚Äî';
            
            console.log('üå¨Ô∏è Qualit√© air - DEFRA:', defra, 'PM2.5:', pm25);
        } else {
            console.log('‚ö†Ô∏è Pas de donn√©es de qualit√© de l\'air disponibles');
            defra = 'Non disponible';
            pm25 = '‚Äî';
        }
        
        // Afficher les donn√©es dans la page
        console.log('üé® D√©but de l\'affichage des donn√©es...');
        console.log('üìä Valeurs √† afficher:', {
            city,
            country,
            condition,
            temperature,
            defra,
            pm25
        });
        
        const cityElement = document.getElementById('city');
        const countryElement = document.getElementById('country');
        const summaryElement = document.getElementById('summary');
        const temperatureElement = document.getElementById('temperature');
        const airQualityElement = document.getElementById('airQualityIndex');
        const pm25Element = document.getElementById('pm25');
        
        // V√©rifier que tous les √©l√©ments existent
        const elements = {
            city: cityElement,
            country: countryElement,
            summary: summaryElement,
            temperature: temperatureElement,
            airQualityIndex: airQualityElement,
            pm25: pm25Element
        };
        
        for (const [name, element] of Object.entries(elements)) {
            if (!element) {
                console.error(`‚ùå √âl√©ment ${name} non trouv√© dans le DOM`);
            }
        }
        
        // Afficher les donn√©es
        if (cityElement) {
            cityElement.textContent = city || '‚Äî';
            console.log('‚úÖ Ville affich√©e:', cityElement.textContent);
        }
        
        if (countryElement) {
            countryElement.textContent = country || '‚Äî';
            console.log('‚úÖ Pays affich√©:', countryElement.textContent);
        }
        
        if (summaryElement) {
            summaryElement.textContent = condition || '‚Äî';
            console.log('‚úÖ Condition affich√©e:', summaryElement.textContent);
        }
        
        if (temperatureElement) {
            temperatureElement.textContent = temperature !== undefined && temperature !== null ? temperature : '‚Äî';
            console.log('‚úÖ Temp√©rature affich√©e:', temperatureElement.textContent);
        }
        
        if (airQualityElement) {
            airQualityElement.textContent = defra || '‚Äî';
            console.log('‚úÖ Qualit√© air affich√©e:', airQualityElement.textContent);
        }
        
        if (pm25Element) {
            pm25Element.textContent = pm25 !== undefined && pm25 !== null ? pm25 : '‚Äî';
            console.log('‚úÖ PM2.5 affich√©:', pm25Element.textContent);
        }
        
        console.log('‚úÖ Toutes les donn√©es affich√©es avec succ√®s');
        console.log('üîç V√©rification finale des valeurs affich√©es:', {
            city: cityElement?.textContent,
            country: countryElement?.textContent,
            condition: summaryElement?.textContent,
            temperature: temperatureElement?.textContent,
            defra: airQualityElement?.textContent,
            pm25: pm25Element?.textContent
        });
        
        // Charger aussi les pr√©visions en arri√®re-plan pour l'onglet Pr√©visions
        loadForecastData(latitude, longitude).catch(err => {
            console.warn('‚ö†Ô∏è Impossible de charger les pr√©visions:', err);
        });
        
    } catch (error) {
        console.error('‚ùå Erreur lors du chargement des donn√©es m√©t√©o:', error);
        console.error('Stack:', error.stack);
        showError('Erreur lors du chargement des donn√©es m√©t√©o: ' + error.message);
        
        // Afficher des valeurs par d√©faut
        const elements = {
            'city': '‚Äî',
            'country': '‚Äî',
            'summary': 'Donn√©es non disponibles',
            'temperature': '‚Äî',
            'airQualityIndex': '‚Äî',
            'pm25': '‚Äî'
        };
        
        for (const [id, value] of Object.entries(elements)) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            } else {
                console.error(`‚ùå √âl√©ment ${id} non trouv√© pour afficher la valeur par d√©faut`);
            }
        }
    }
}

// Fonction pour changer d'onglet
function showTab(tabName) {
    // Masquer tous les contenus d'onglets
    document.getElementById('tab-content-current').style.display = 'none';
    document.getElementById('tab-content-forecast').style.display = 'none';
    
    // D√©sactiver tous les onglets
    document.getElementById('tab-current').classList.remove('active');
    document.getElementById('tab-forecast').classList.remove('active');
    
    // Afficher l'onglet s√©lectionn√©
    if (tabName === 'current') {
        document.getElementById('tab-content-current').style.display = 'block';
        document.getElementById('tab-current').classList.add('active');
    } else if (tabName === 'forecast') {
        document.getElementById('tab-content-forecast').style.display = 'block';
        document.getElementById('tab-forecast').classList.add('active');
        
        // Charger les pr√©visions si on a les coordonn√©es
        if (lat && long) {
            loadForecastData(lat, long);
        } else {
            document.getElementById('forecast-container').style.display = 'none';
            document.getElementById('forecast-no-data').style.display = 'block';
        }
    }
}

// Fonction pour charger les pr√©visions m√©t√©o
async function loadForecastData(latitude, longitude) {
    try {
        console.log('üìÖ Chargement des pr√©visions pour:', latitude, longitude);
        
        const apiKey = getApiKey();
        
        if (!apiKey) {
            throw new Error('Veuillez d\'abord configurer votre cl√© API WeatherAPI');
        }
        
        // Appel √† l'API WeatherAPI pour les pr√©visions (7 jours avec pr√©visions horaires)
        const apiUrl = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${latitude},${longitude}&days=7&aqi=yes&alerts=yes`;
        console.log('üì° Appel API Pr√©visions:', apiUrl.replace(apiKey, 'API_KEY_HIDDEN'));
        
        let response;
        try {
            response = await fetch(apiUrl, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json'
                }
            });
        } catch (fetchError) {
            console.error('‚ùå Erreur de fetch:', fetchError);
            if (fetchError.message.includes('CORS') || fetchError.message.includes('Failed to fetch')) {
                throw new Error('Erreur CORS: L\'API n√©cessite que la page soit servie via HTTP/HTTPS.');
            }
            throw fetchError;
        }
        
        let json;
        const contentType = response.headers.get('content-type');
        
        if (!response.ok) {
            let errorMessage = `Erreur HTTP: ${response.status}`;
            try {
                if (contentType && contentType.includes('application/json')) {
                    json = await response.json();
                    console.error('‚ùå Erreur HTTP:', response.status, json);
                    errorMessage = json.error?.message || errorMessage;
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur HTTP (texte):', response.status, errorText);
                    errorMessage = errorText || errorMessage;
                }
            } catch (e) {
                console.error('‚ùå Erreur lors de la lecture de la r√©ponse:', e);
            }
            throw new Error(errorMessage);
        }
        
        try {
            if (contentType && contentType.includes('application/json')) {
                json = await response.json();
            } else {
                const text = await response.text();
                console.error('‚ùå R√©ponse non-JSON re√ßue:', text);
                throw new Error('R√©ponse invalide du serveur (non-JSON)');
            }
        } catch (e) {
            console.error('‚ùå Erreur lors du parsing JSON:', e);
            throw new Error('R√©ponse invalide du serveur: ' + e.message);
        }
        
        console.log('‚úÖ Donn√©es de pr√©visions re√ßues:', json);
        
        if (json.error) {
            throw new Error(json.error.message || 'Erreur API m√©t√©o');
        }
        
        if (!json.location || !json.current || !json.forecast) {
            throw new Error('Donn√©es de pr√©visions incompl√®tes');
        }
        
        // Afficher les pr√©visions
        displayForecastData(json);
        
    } catch (error) {
        console.error('‚ùå Erreur lors du chargement des pr√©visions:', error);
        showError('Erreur lors du chargement des pr√©visions: ' + error.message);
        document.getElementById('forecast-container').style.display = 'none';
        document.getElementById('forecast-no-data').style.display = 'block';
    }
}

// Fonction pour afficher les donn√©es de pr√©visions
function displayForecastData(data) {
    const location = data.location;
    const current = data.current;
    const forecast = data.forecast;
    
    // Afficher le conteneur
    document.getElementById('forecast-container').style.display = 'block';
    document.getElementById('forecast-no-data').style.display = 'none';
    
    // Jour actuel
    const now = new Date();
    const days = ['DIMANCHE', 'LUNDI', 'MARDI', 'MERCREDI', 'JEUDI', 'VENDREDI', 'SAMEDI'];
    const months = ['JANVIER', 'F√âVRIER', 'MARS', 'AVRIL', 'MAI', 'JUIN', 'JUILLET', 'AO√õT', 'SEPTEMBRE', 'OCTOBRE', 'NOVEMBRE', 'D√âCEMBRE'];
    
    document.getElementById('current-day').textContent = days[now.getDay()];
    document.getElementById('current-date').textContent = `${now.getDate()} ${months[now.getMonth()]}`;
    document.getElementById('current-temp').textContent = `${Math.round(current.temp_c)}¬∞C`;
    document.getElementById('current-condition').textContent = current.condition.text.toUpperCase();
    
    if (current.condition.icon) {
        const iconEl = document.getElementById('current-icon-large');
        let iconUrl = current.condition.icon;
        if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
        iconEl.src = iconUrl;
        iconEl.style.display = 'block';
    }
    
    // M√©triques d√©taill√©es
    document.getElementById('uv-index').textContent = `${current.uv} / 10`;
    document.getElementById('wind').textContent = `${current.wind_dir} ${Math.round(current.wind_kph)} km/h`;
    document.getElementById('humidity').textContent = `${current.humidity}%`;
    document.getElementById('dew-point').textContent = `${Math.round(current.dewpoint_c)}¬∞C`;
    document.getElementById('pressure').textContent = `${current.pressure_mb} mb`;
    document.getElementById('visibility').textContent = `${current.vis_km} km`;
    document.getElementById('sunrise').textContent = forecast.forecastday[0].astro.sunrise;
    document.getElementById('sunset').textContent = forecast.forecastday[0].astro.sunset;
    
    // Pr√©visions horaires (prochaines 24h)
    const hourlyContainer = document.getElementById('hourly-forecast');
    hourlyContainer.innerHTML = '';
    
    const todayHours = forecast.forecastday[0].hour;
    const currentHour = now.getHours();
    
    // Afficher les heures √† partir de maintenant
    const hoursToShow = todayHours.slice(currentHour).slice(0, 12);
    
    hoursToShow.forEach(hour => {
        const hourDate = new Date(hour.time);
        const hourDiv = document.createElement('div');
        hourDiv.className = 'text-center';
        hourDiv.style.minWidth = '80px';
        
        let iconUrl = hour.condition.icon;
        if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
        
        hourDiv.innerHTML = `
            <div class="fw-bold mb-2 text-white">${hourDate.getHours()}h</div>
            <img src="${iconUrl}" alt="${hour.condition.text}" style="width: 40px; height: 40px;" class="mb-2">
            <div class="fw-bold text-white">${Math.round(hour.temp_c)}¬∞C</div>
        `;
        hourlyContainer.appendChild(hourDiv);
    });
    
    // Aujourd'hui
    const today = forecast.forecastday[0].day;
    document.getElementById('today-high').textContent = `${Math.round(today.maxtemp_c)}¬∞C`;
    document.getElementById('today-condition').textContent = today.condition.text.toUpperCase();
    document.getElementById('today-low').textContent = `${Math.round(today.mintemp_c)}¬∞C`;
    document.getElementById('today-night-condition').textContent = today.condition.text.toUpperCase();
    
    if (today.condition.icon) {
        let iconUrl = today.condition.icon;
        if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
        document.getElementById('today-icon').src = iconUrl;
        document.getElementById('today-icon').style.display = 'block';
        document.getElementById('today-night-icon').src = iconUrl;
        document.getElementById('today-night-icon').style.display = 'block';
    }
    
    // Demain
    const tomorrow = forecast.forecastday[1].day;
    document.getElementById('tomorrow-high').textContent = `${Math.round(tomorrow.maxtemp_c)}¬∞C`;
    document.getElementById('tomorrow-condition').textContent = tomorrow.condition.text.toUpperCase();
    document.getElementById('tomorrow-low').textContent = `${Math.round(tomorrow.mintemp_c)}¬∞C`;
    document.getElementById('tomorrow-night-condition').textContent = tomorrow.condition.text.toUpperCase();
    
    if (tomorrow.condition.icon) {
        let iconUrl = tomorrow.condition.icon;
        if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
        document.getElementById('tomorrow-icon').src = iconUrl;
        document.getElementById('tomorrow-icon').style.display = 'block';
        document.getElementById('tomorrow-night-icon').src = iconUrl;
        document.getElementById('tomorrow-night-icon').style.display = 'block';
    }
    
    // Pr√©visions par partie de journ√©e (aujourd'hui)
    const morningHour = todayHours.find(h => new Date(h.time).getHours() >= 6 && new Date(h.time).getHours() < 12) || todayHours[6];
    const afternoonHour = todayHours.find(h => new Date(h.time).getHours() >= 12 && new Date(h.time).getHours() < 18) || todayHours[12];
    const eveningHour = todayHours.find(h => new Date(h.time).getHours() >= 18) || todayHours[18];
    
    if (morningHour) {
        document.getElementById('morning-temp').textContent = `${Math.round(morningHour.temp_c)}¬∞C`;
        document.getElementById('morning-condition').textContent = morningHour.condition.text.toUpperCase();
        if (morningHour.condition.icon) {
            let iconUrl = morningHour.condition.icon;
            if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
            document.getElementById('morning-icon').src = iconUrl;
            document.getElementById('morning-icon').style.display = 'block';
        }
    }
    
    if (afternoonHour) {
        document.getElementById('afternoon-temp').textContent = `${Math.round(afternoonHour.temp_c)}¬∞C`;
        document.getElementById('afternoon-condition').textContent = afternoonHour.condition.text.toUpperCase();
        if (afternoonHour.condition.icon) {
            let iconUrl = afternoonHour.condition.icon;
            if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
            document.getElementById('afternoon-icon').src = iconUrl;
            document.getElementById('afternoon-icon').style.display = 'block';
        }
    }
    
    if (eveningHour) {
        document.getElementById('evening-temp').textContent = `${Math.round(eveningHour.temp_c)}¬∞C`;
        document.getElementById('evening-condition').textContent = eveningHour.condition.text.toUpperCase();
        if (eveningHour.condition.icon) {
            let iconUrl = eveningHour.condition.icon;
            if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
            document.getElementById('evening-icon').src = iconUrl;
            document.getElementById('evening-icon').style.display = 'block';
        }
    }
    
    // Pr√©visions sur 7 jours
    const sevenDayContainer = document.getElementById('7day-forecast');
    sevenDayContainer.innerHTML = '';
    
    forecast.forecastday.forEach((day, index) => {
        const dayDate = new Date(day.date);
        const dayNames = ['DIM', 'LUN', 'MAR', 'MER', 'JEU', 'VEN', 'SAM'];
        const dayDiv = document.createElement('div');
        dayDiv.className = 'text-center p-3';
        dayDiv.style.minWidth = '120px';
        dayDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        dayDiv.style.borderRadius = '10px';
        
        let iconUrl = day.day.condition.icon;
        if (iconUrl.startsWith('//')) iconUrl = 'https:' + iconUrl;
        
        dayDiv.innerHTML = `
            <div class="fw-bold mb-2 text-white">${dayNames[dayDate.getDay()]}</div>
            <img src="${iconUrl}" alt="${day.day.condition.text}" style="width: 50px; height: 50px;" class="mb-2">
            <div class="fw-bold text-white">${Math.round(day.day.maxtemp_c)}¬∞C</div>
            <div class="text-white-50 small">${Math.round(day.day.mintemp_c)}¬∞C</div>
        `;
        sevenDayContainer.appendChild(dayDiv);
    });
    
    console.log('‚úÖ Pr√©visions affich√©es avec succ√®s');
}

// Fonction pour sauvegarder les donn√©es dans localStorage
function saveToLocalStorage(data) {
    try {
        let records = JSON.parse(localStorage.getItem('weatherRecords') || '[]');
        records.push(data);
        localStorage.setItem('weatherRecords', JSON.stringify(records));
        return true;
    } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error);
        return false;
    }
}

// Gestionnaire de clic pour le bouton Envoyer
let button = null;
document.addEventListener('DOMContentLoaded', () => {
    // Charger la cl√© API si elle existe
    const savedApiKey = getApiKey();
    if (savedApiKey) {
        document.getElementById('api-key').value = savedApiKey;
        const statusEl = document.getElementById('api-key-status');
        if (statusEl) {
            statusEl.innerHTML = '<div class="alert alert-success">‚úÖ Cl√© API configur√©e</div>';
            statusEl.style.display = 'block';
        }
    }
    
    // Bouton pour sauvegarder la cl√© API
    const saveApiKeyButton = document.getElementById('save-api-key');
    const apiKeyStatus = document.getElementById('api-key-status');
    
    if (saveApiKeyButton) {
        saveApiKeyButton.addEventListener('click', () => {
            const apiKey = document.getElementById('api-key').value.trim();
            if (apiKey) {
                saveApiKey(apiKey);
                if (apiKeyStatus) {
                    apiKeyStatus.innerHTML = '<div class="alert alert-success">‚úÖ Cl√© API enregistr√©e avec succ√®s !</div>';
                    apiKeyStatus.style.display = 'block';
                }
            } else {
                if (apiKeyStatus) {
                    apiKeyStatus.innerHTML = '<div class="alert alert-danger">‚ùå Veuillez entrer une cl√© API</div>';
                    apiKeyStatus.style.display = 'block';
                }
            }
        });
    }
    
    // Afficher le statut de la cl√© API au chargement
    if (savedApiKey && apiKeyStatus) {
        apiKeyStatus.innerHTML = '<div class="alert alert-success">‚úÖ Cl√© API configur√©e</div>';
        apiKeyStatus.style.display = 'block';
    }
    
    // Gestion de la s√©lection d'humeur
    document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // R√©initialiser tous les boutons
            document.querySelectorAll('.mood-btn').forEach(b => {
                b.classList.remove('btn-primary', 'btn-success', 'btn-warning', 'btn-danger');
                b.classList.add('btn-outline-secondary');
                b.style.border = '3px solid transparent';
                b.style.transform = 'scale(1)';
            });
            
            // Activer le bouton s√©lectionn√©
            const mood = this.getAttribute('data-mood');
            const emoji = this.getAttribute('data-emoji');
            
            document.getElementById('mood').value = mood;
            document.getElementById('mood-emoji').value = emoji;
            
            // Style selon l'humeur
            this.classList.remove('btn-outline-secondary');
            if (mood === 'happy') {
                this.classList.add('btn-success');
            } else if (mood === 'neutral') {
                this.classList.add('btn-warning');
            } else if (mood === 'sad') {
                this.classList.add('btn-danger');
            }
            this.style.border = '3px solid #667eea';
            this.style.transform = 'scale(1.05)';
        });
    });
    
    button = document.getElementById('submit');
    if (button) {
        button.addEventListener('click', async event => {
            if (!lat || !long) {
                showError('Veuillez attendre que votre position soit d√©tect√©e');
                return;
            }
            
            const mood = document.getElementById('mood').value;
            const moodEmoji = document.getElementById('mood-emoji').value;
            
            if (!mood) {
                showError('Veuillez s√©lectionner votre humeur');
                return;
            }
            
            // Sauvegarder dans localStorage
            const data = {
                lat,
                long,
                mood,
                moodEmoji,
                country,
                city,
                condition,
                temperature,
                defra,
                pm25,
                timestamp: Date.now()
            };
            
            try {
                // Sauvegarder dans localStorage
                let records = JSON.parse(localStorage.getItem('weatherRecords') || '[]');
                records.push(data);
                localStorage.setItem('weatherRecords', JSON.stringify(records));
                
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success mt-3';
                successDiv.textContent = '‚úÖ Donn√©es enregistr√©es avec succ√®s !';
                const container = document.querySelector('.col-12.col-sm-10.col-md-8');
                if (container) {
                    container.appendChild(successDiv);
                    setTimeout(() => successDiv.remove(), 3000);
                }
                
                // R√©initialiser la s√©lection d'humeur
                document.getElementById('mood').value = '';
                document.getElementById('mood-emoji').value = '';
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.remove('btn-primary', 'btn-success', 'btn-warning', 'btn-danger');
                    btn.classList.add('btn-outline-secondary');
                    btn.style.border = '3px solid transparent';
                    btn.style.transform = 'scale(1)';
                });
            } catch (error) {
                console.error('Erreur lors de l\'enregistrement:', error);
                showError('Erreur lors de l\'enregistrement des donn√©es');
            }
        });
    }
});

// Fonction pour demander la g√©olocalisation
function requestGeolocation() {
    console.log('requestGeolocation() appel√©e');
    
    if (!("geolocation" in navigator)) {
        showError('La g√©olocalisation n\'est pas disponible sur votre navigateur');
        return;
    }

    // Masquer le prompt et afficher le chargement
    const prompt = document.getElementById('geolocation-prompt');
    const display = document.getElementById('coordinates-display');
    const latElement = document.getElementById('latitude');
    const longElement = document.getElementById('longitude');
    
    if (prompt) {
        prompt.style.display = 'none';
    }
    
    if (display) {
        display.style.display = 'block';
    }
    
    if (latElement) {
        latElement.textContent = 'Chargement...';
    }
    
    if (longElement) {
        longElement.textContent = 'Chargement...';
    }
    
    console.log('Demande de g√©olocalisation envoy√©e au navigateur...');

    // Options pour la g√©olocalisation
    const options = {
        enableHighAccuracy: true,  // Utiliser la meilleure pr√©cision disponible
        timeout: 10000,            // Timeout de 10 secondes
        maximumAge: 0              // Ne pas utiliser de position en cache
    };

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            try {
                console.log('‚úÖ Position obtenue avec succ√®s');
                
                // R√©cup√©rer et afficher les coordonn√©es
                lat = position.coords.latitude;
                long = position.coords.longitude;
                
                console.log('Coordonn√©es r√©cup√©r√©es:', lat, long);
                console.log('Pr√©cision:', position.coords.accuracy, 'm√®tres');
                
                // S'assurer que les √©l√©ments existent avant de les modifier
                const latElement = document.getElementById('latitude');
                const longElement = document.getElementById('longitude');
                
                if (latElement && longElement) {
                    latElement.textContent = lat.toFixed(6);
                    longElement.textContent = long.toFixed(6);
                    console.log('Coordonn√©es affich√©es dans le DOM');
                } else {
                    console.error('√âl√©ments latitude/longitude non trouv√©s');
                }
                
                // Charger les donn√©es m√©t√©o
                await loadWeatherData(lat, long);
                
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur lors de la r√©cup√©ration de votre position: ' + error.message);
                const latElement = document.getElementById('latitude');
                const longElement = document.getElementById('longitude');
                if (latElement) latElement.textContent = '‚Äî';
                if (longElement) longElement.textContent = '‚Äî';
            }
        },
        (error) => {
            console.error('Erreur de g√©olocalisation:', error);
            let errorMessage = '';
            let showPromptAgain = false;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '‚ùå Permission refus√©e. Veuillez autoriser la g√©olocalisation dans les param√®tres de votre navigateur et r√©essayez.';
                    showPromptAgain = true;
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '‚ö†Ô∏è Position indisponible. V√©rifiez que votre GPS est activ√©.';
                    showPromptAgain = true;
                    break;
                case error.TIMEOUT:
                    errorMessage = '‚è±Ô∏è Timeout. La demande de g√©olocalisation a pris trop de temps. Veuillez r√©essayer.';
                    showPromptAgain = true;
                    break;
                default:
                    errorMessage = '‚ùå Erreur inconnue lors de la r√©cup√©ration de la position.';
                    showPromptAgain = true;
                    break;
            }
            
            showError(errorMessage);
            document.getElementById('latitude').textContent = '‚Äî';
            document.getElementById('longitude').textContent = '‚Äî';
            
            // R√©afficher le prompt si l'utilisateur peut r√©essayer
            if (showPromptAgain) {
                document.getElementById('geolocation-prompt').style.display = 'block';
                document.getElementById('coordinates-display').style.display = 'none';
            }
        },
        options
    );
}

// Initialiser les event listeners quand le DOM est pr√™t
function initializeApp() {
    // V√©rifier si la g√©olocalisation est disponible
    if ("geolocation" in navigator) {
        console.log('‚úÖ G√©olocalisation disponible');
        
        // Ajouter l'√©v√©nement au bouton de demande
        const requestButton = document.getElementById('request-geolocation');
        if (requestButton) {
            requestButton.addEventListener('click', () => {
                console.log('Bouton cliqu√© - Demande de g√©olocalisation');
                requestGeolocation();
    });
} else {
            console.error('Bouton request-geolocation non trouv√©');
        }
        
        // Ajouter l'√©v√©nement au bouton d'actualisation
        const refreshButton = document.getElementById('refresh-location');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                console.log('Bouton actualisation cliqu√©');
                requestGeolocation();
            });
        }
        
    } else {
        console.log('‚ùå G√©olocalisation non disponible');
        const prompt = document.getElementById('geolocation-prompt');
        if (prompt) {
            prompt.innerHTML = `
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è G√©olocalisation non disponible</strong><br>
                    Votre navigateur ne supporte pas la g√©olocalisation. Veuillez utiliser un navigateur moderne.
                </div>
            `;
        }
    }
}

// Attendre que le DOM soit charg√©
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    // DOM d√©j√† charg√©
    initializeApp();
    }
</script>

</body>
</html>
